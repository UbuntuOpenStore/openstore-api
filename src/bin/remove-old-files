#!/usr/bin/env node


require('../db'); // Make sure the database connection gets setup
const Package = require('../db/package/model');
const config = require('../utils/config');
const fs = require('../utils/async-fs');

Package.find({}).then((pkgs) => {
    const knownFiles = pkgs.flatMap((pkg) => {
        let files = [];

        if (pkg.revisions) {
            files = files.concat(
                pkg.revisions.filter((revision) => revision.download_url)
                    .map((revision) => revision.download_url),
            );
        }

        if (pkg.screenshots) {
            files = files.concat(
                pkg.screenshots.map((screenshot) => `${config.image_dir}/${screenshot.replace('https://open-store.io/api/screenshot/', '')}`),
            );
        }

        if (pkg.icon) {
            files.push(pkg.icon);
        }

        return files;
    });

    const dirFiles = fs.readdirSync(config.data_dir).map((file) => `${config.data_dir}/${file}`);

    const diff = dirFiles.filter((file) => !knownFiles.includes(file));
    return Promise.all(diff.map((file) => {
        console.log('removing ' + file);
        fs.unlinkAsync(file);
    }));
}).then(() => {
    console.log('done');
    process.exit(0);
}).catch((err) => {
    console.log(err);
    process.exit(1);
});
